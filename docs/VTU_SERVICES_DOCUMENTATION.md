# VTU Services Documentation\n\n## Overview\n\nThis document describes the implementation of VTU (Value Transfer Unit) services integrated with Clubkonnect API. The implementation provides comprehensive support for:\n\n- üì± **Airtime Top-Up** - Buy airtime for all major Nigerian networks\n- üåê **Data Purchase** - Buy data bundles with network-specific plans\n- üì∫ **Cable TV Subscription** - Pay for DStv, GOtv, and Startimes\n- ‚ö° **Electricity Bill Payment** - Pay electricity bills for all major DISCOs\n- üîç **Validation Services** - Validate smartcard numbers and meter numbers\n- üìä **Service Variations** - Dynamic fetching and caching of plans/pricing\n\n## Architecture\n\n### Core Components\n\n1. **VTU Service** (`services/vtuService.js`)\n   - Main service class handling all VTU operations\n   - Integrates with Clubkonnect API endpoints\n   - Implements caching for service variations\n   - Handles transaction logging\n\n2. **VTU Controller** (`controllers/vtuController.js`)\n   - HTTP endpoint handlers\n   - Request validation and sanitization\n   - Wallet balance management\n   - Reseller discount calculations\n   - Transaction management\n\n3. **Clubkonnect Configuration** (`config/clubkonnect.js`)\n   - Centralized API configuration\n   - Endpoint definitions\n   - Network mappings\n   - Authentication parameters\n\n4. **VTU Routes** (`routes/vtu.js`)\n   - RESTful API endpoints\n   - Authentication middleware\n   - Request validation\n\n## API Endpoints\n\n### Information Endpoints\n\n#### Get Networks\n```http\nGET /api/v1/vtu/networks\n```\n\nReturns available mobile networks for airtime and data purchases.\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Networks retrieved successfully\",\n  \"data\": [\n    {\n      \"id\": \"01\",\n      \"name\": \"MTN\",\n      \"code\": \"MTN\"\n    },\n    {\n      \"id\": \"02\",\n      \"name\": \"GLO\",\n      \"code\": \"GLO\"\n    }\n  ]\n}\n```\n\n#### Get Data Plans\n```http\nGET /api/v1/vtu/data-plans/:network\n```\n\nReturns available data plans for a specific network.\n\n**Parameters:**\n- `network` - Network code (MTN, GLO, AIRTEL, 9MOBILE)\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Data plans retrieved successfully\",\n  \"data\": [\n    {\n      \"id\": \"MTN-1GB-30\",\n      \"name\": \"1GB - 30 Days\",\n      \"price\": 350,\n      \"data\": \"1GB\",\n      \"validity\": \"30 days\"\n    }\n  ]\n}\n```\n\n#### Get Cable Providers\n```http\nGET /api/v1/vtu/cable-providers\n```\n\nReturns available cable TV providers.\n\n#### Get Cable Packages\n```http\nGET /api/v1/vtu/cable-packages/:provider\n```\n\nReturns available packages for a cable provider.\n\n#### Get Electricity Providers\n```http\nGET /api/v1/vtu/electricity-providers\n```\n\nReturns available electricity distribution companies (DISCOs).\n\n### Purchase Endpoints\n\n#### Purchase Airtime\n```http\nPOST /api/v1/vtu/airtime\n```\n\n**Request Body:**\n```json\n{\n  \"network\": \"MTN\",\n  \"phone_number\": \"08012345678\",\n  \"amount\": 100\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Airtime purchase successful\",\n  \"data\": {\n    \"transaction\": {\n      \"id\": \"uuid\",\n      \"status\": \"completed\",\n      \"payment_reference\": \"AIRTIME_1234567890_ABC123\"\n    },\n    \"new_balance\": 4900,\n    \"vtu_reference\": \"AIRTIME_1234567890_ABC123\"\n  }\n}\n```\n\n#### Purchase Data\n```http\nPOST /api/v1/vtu/data\n```\n\n**Request Body:**\n```json\n{\n  \"network\": \"MTN\",\n  \"phone_number\": \"08012345678\",\n  \"plan_id\": \"MTN-1GB-30\",\n  \"amount\": 350\n}\n```\n\n#### Purchase Cable TV\n```http\nPOST /api/v1/vtu/cable\n```\n\n**Request Body:**\n```json\n{\n  \"provider\": \"dstv\",\n  \"package_id\": \"dstv-compact\",\n  \"smartcard_number\": \"1234567890\",\n  \"amount\": 10500\n}\n```\n\n#### Purchase Electricity\n```http\nPOST /api/v1/vtu/electricity\n```\n\n**Request Body:**\n```json\n{\n  \"provider\": \"ikeja\",\n  \"meter_number\": \"12345678901\",\n  \"meter_type\": \"prepaid\",\n  \"amount\": 5000,\n  \"customer_name\": \"John Doe\"\n}\n```\n\n### Validation Endpoints\n\n#### Validate Smartcard\n```http\nPOST /api/v1/vtu/validate/smartcard\n```\n\n**Request Body:**\n```json\n{\n  \"provider\": \"dstv\",\n  \"smartcard_number\": \"1234567890\"\n}\n```\n\n#### Validate Meter\n```http\nPOST /api/v1/vtu/validate/meter\n```\n\n**Request Body:**\n```json\n{\n  \"provider\": \"ikeja\",\n  \"meter_number\": \"12345678901\",\n  \"meter_type\": \"prepaid\"\n}\n```\n\n### Utility Endpoints\n\n#### Get VTU Balance\n```http\nGET /api/v1/vtu/balance\n```\n\nReturns the Clubkonnect account balance.\n\n#### Get Transaction Status\n```http\nGET /api/v1/vtu/transaction-status/:request_id\n```\n\nChecks the status of a VTU transaction.\n\n### Callback Endpoint\n\n#### VTU Callback\n```http\nPOST /api/v1/vtu/callback\n```\n\nReceives transaction status updates from Clubkonnect (no authentication required).\n\n## Configuration\n\n### Environment Variables\n\nAdd these variables to your `.env` file:\n\n```env\n# Clubkonnect API Configuration\nCLUBKONNECT_BASE_URL=https://www.clubkonnect.com\nCLUBKONNECT_USERID=your_clubkonnect_user_id\nCLUBKONNECT_APIKEY=your_clubkonnect_api_key\nCLUBKONNECT_CALLBACK_URL=https://your-backend-app.onrender.com/api/v1/vtu/callback\nCLUBKONNECT_EMAIL=your_clubkonnect_email@example.com\n\n# Optional: API timeout and retry settings\nCLUBKONNECT_TIMEOUT=30000\nCLUBKONNECT_RETRY_ATTEMPTS=3\nCLUBKONNECT_RETRY_DELAY=5000\n```\n\n### Clubkonnect API Endpoints\n\nThe service integrates with these Clubkonnect endpoints:\n\n- **Airtime**: `/APIAirtimeV1.asp`\n- **Data**: `/APIDataV1.asp`\n- **Cable TV**: `/APICableTVV1.asp`\n- **Electricity**: `/APIElectricityV1.asp`\n- **Balance**: `/APIBalanceV1.asp`\n- **Data Plans**: `/APIDataPlansV1.asp`\n- **Networks**: `/APINetworksV1.asp`\n- **Transaction Status**: `/APITransactionStatusV1.asp`\n\n## Features\n\n### Service Variations Caching\n\nThe service implements intelligent caching for:\n- Mobile networks\n- Data plans per network\n- Cable TV providers and packages\n- Electricity providers\n\nCache expires after 5 minutes to ensure fresh data.\n\n### Transaction Logging\n\nAll VTU transactions are logged to the `vtu_transaction_logs` table:\n\n```sql\nCREATE TABLE vtu_transaction_logs (\n    id UUID PRIMARY KEY,\n    type VARCHAR(50) NOT NULL,\n    network VARCHAR(50),\n    phone_number VARCHAR(20),\n    amount DECIMAL(10,2) NOT NULL,\n    request_id VARCHAR(100) UNIQUE,\n    provider_response JSONB,\n    status VARCHAR(20) DEFAULT 'pending',\n    metadata JSONB,\n    created_at TIMESTAMP,\n    updated_at TIMESTAMP\n);\n```\n\n### Reseller Discounts\n\nThe system automatically applies reseller discounts:\n- Airtime discount from `resellers.airtime_discount`\n- Data discount from `resellers.data_discount`\n- Cable discount from `resellers.cable_discount`\n- Electricity discount from `resellers.electricity_discount`\n\n### Error Handling\n\nComprehensive error handling includes:\n- Network validation\n- Phone number format validation\n- Wallet balance checks\n- Provider API error handling\n- Transaction rollback on failure\n\n### Real-time Updates\n\nThe system provides real-time updates via:\n- Wallet balance updates\n- Transaction status notifications\n- Callback processing\n\n## Testing\n\n### Test Script\n\nRun the comprehensive test script:\n\n```bash\nnode test-clubkonnect-vtu.js\n```\n\nThis script tests:\n- Configuration validation\n- Network retrieval\n- Data plans fetching\n- Cable providers and packages\n- Electricity providers\n- Validation services\n- Balance checking\n- Network ID mapping\n\n### Manual Testing\n\nUse these curl commands for manual testing:\n\n```bash\n# Get networks\ncurl -X GET \"http://localhost:8000/api/v1/vtu/networks\" \\\n  -H \"Authorization: Bearer your_jwt_token\"\n\n# Purchase airtime\ncurl -X POST \"http://localhost:8000/api/v1/vtu/airtime\" \\\n  -H \"Authorization: Bearer your_jwt_token\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"network\": \"MTN\",\n    \"phone_number\": \"08012345678\",\n    \"amount\": 100\n  }'\n```\n\n## Security Considerations\n\n1. **Authentication**: All endpoints require valid JWT tokens\n2. **Input Validation**: Comprehensive request validation\n3. **Rate Limiting**: Consider implementing rate limiting\n4. **Callback Security**: Validate callback sources\n5. **Transaction Logging**: All transactions are logged for audit\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Missing Configuration**\n   - Ensure all `CLUBKONNECT_*` environment variables are set\n   - Check Clubkonnect credentials are valid\n\n2. **Network Errors**\n   - Verify Clubkonnect API endpoints are accessible\n   - Check network connectivity\n\n3. **Transaction Failures**\n   - Check wallet balance\n   - Verify phone number format\n   - Check Clubkonnect account balance\n\n4. **Callback Issues**\n   - Ensure callback URL is publicly accessible\n   - Check firewall settings\n   - Verify webhook endpoint configuration\n\n### Logging\n\nThe service provides comprehensive logging:\n- Request/response logging\n- Error logging\n- Transaction logging\n- Callback processing logs\n\n### Support\n\nFor support:\n1. Check the logs for error details\n2. Run the test script to verify configuration\n3. Contact Clubkonnect support for API issues\n4. Review transaction logs for failed transactions\n\n---\n\n## Next Steps\n\n1. **Production Deployment**\n   - Set up proper environment variables\n   - Configure callback URLs\n   - Test with real Clubkonnect credentials\n\n2. **Monitoring**\n   - Set up transaction monitoring\n   - Configure alerts for failed transactions\n   - Monitor API response times\n\n3. **Optimization**\n   - Implement advanced caching strategies\n   - Add retry mechanisms\n   - Optimize database queries\n\n4. **Additional Features**\n   - Add transaction history endpoints\n   - Implement refund mechanisms\n   - Add admin dashboard for transaction monitoring
